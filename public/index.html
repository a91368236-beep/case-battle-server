<script>
const id = localStorage.playerId ??= crypto.randomUUID();

async function load() {
  const r = await fetch(`/stats?id=${id}`);
  const d = await r.json();

  balance.textContent = d.balance;
  opened.textContent = d.opened;
  online.textContent = d.online;

  inv.innerHTML = Object.values(d.inventory).length
    ? Object.values(d.inventory).map(i => `
      <div class="inv-item ${i.rarity}">
        ${i.weapon} | ${i.skin} × ${i.qty}
      </div>
    `).join("")
    : "Пусто";
}

async function openCases() {
  const c = count.value;
  const r = await fetch(`/open?id=${id}&count=${c}`);
  const d = await r.json();
  if (d.error) return alert("Недостаточно монет");

  caseView.textContent = d.drops
    .map(i => `${i.weapon} | ${i.skin}`)
    .join(" | ");

  load();
}

async function sellAll() {
  await fetch(`/sell?id=${id}`);
  load();
}

async function loadFeed() {
  const r = await fetch(`/feed`);
  const d = await r.json();

  feed.innerHTML = d.map(f => `
    <div class="feed-item ${f.rarity}">
      ${f.player} выбил ${f.item}
    </div>
  `).join("");
}

load();
loadFeed();
setInterval(loadFeed, 2500);
</script>